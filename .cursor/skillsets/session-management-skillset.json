{
  "name": "Session Management Specialist",
  "domain": "session-crud",
  "version": "1.0",
  "expertise": [
    "session-lifecycle",
    "attachment-handling",
    "preset-linking",
    "persistence",
    "normalization"
  ],
  "data_structures": {
    "Session": {
      "schema": {
        "id": "string (UUID or slug)",
        "name": "string",
        "instructions": "string (system prompt override)",
        "presetId": "string | null (reference to instruction preset)",
        "attachments": "array (max 10 files)",
        "history": "array (chat messages)",
        "createdAt": "ISO8601 string",
        "updatedAt": "ISO8601 string"
      },
      "constraints": {
        "id": "Must be unique, alphanumeric + hyphens",
        "name": "Required, min 1 char",
        "attachments": "Max 10 items, each ≤200KB",
        "default_session": "ID 'default' cannot be deleted"
      }
    },
    "Attachment": {
      "schema": {
        "id": "string (UUID)",
        "name": "string (max 120 chars)",
        "type": "enum ['file', 'text']",
        "content": "string (max 200KB)"
      },
      "limits": {
        "MAX_ATTACHMENTS": 10,
        "ATTACHMENT_CHAR_LIMIT": 200000
      },
      "location": "server.js:459-474"
    },
    "SessionStore": {
      "schema": {
        "activeSessionId": "string",
        "sessions": "object { [id: string]: Session }"
      },
      "persistence": "storage/sessions.json",
      "location": "server.js:283-307"
    }
  },
  "api_contracts": {
    "GET /api/sessions": {
      "location": "server.js:1468-1485",
      "response": {
        "activeSessionId": "string",
        "sessions": "array of Session objects"
      },
      "note": "Converts sessions object to array for frontend"
    },
    "GET /api/sessions/:id": {
      "location": "server.js:1487-1509",
      "params": {
        "id": "Session ID"
      },
      "response": "Session object or 404",
      "example": "GET /api/sessions/default"
    },
    "POST /api/sessions": {
      "location": "server.js:1511-1526",
      "request": {
        "id": "string (optional, auto-generated if missing)",
        "name": "string (required)",
        "instructions": "string (optional)",
        "presetId": "string (optional)",
        "attachments": "array (optional)"
      },
      "response": "Created Session object",
      "validation": "normalizeSession() applied"
    },
    "PUT /api/sessions/:id": {
      "location": "server.js:1528-1561",
      "request": "Partial Session (id, name, instructions, presetId, attachments)",
      "response": "Updated Session object or 404",
      "note": "Preserves existing history"
    },
    "DELETE /api/sessions/:id": {
      "location": "server.js:1563-1583",
      "params": {
        "id": "Session ID"
      },
      "response": "204 No Content or 400/404",
      "protection": "Cannot delete 'default' session",
      "side_effect": "Switches to 'default' if deleting active session"
    },
    "POST /api/sessions/:id/select": {
      "location": "server.js:1487-1509",
      "purpose": "Set active session",
      "params": {
        "id": "Session ID"
      },
      "response": "Session object or 404",
      "side_effect": "Updates sessionStore.activeSessionId"
    }
  },
  "patterns": {
    "session_normalization": {
      "description": "Sanitize and validate session data",
      "code_template": "function normalizeSession(session, fallbackName = 'Untitled Session') {\n  const now = new Date().toISOString();\n  return {\n    id: session.id || crypto.randomUUID(),\n    name: session.name || fallbackName,\n    instructions: session.instructions || '',\n    presetId: session.presetId || null,\n    attachments: Array.isArray(session.attachments) ? session.attachments : [],\n    history: Array.isArray(session.history) ? session.history : [],\n    createdAt: session.createdAt || now,\n    updatedAt: session.updatedAt || now\n  };\n}",
      "location": "server.js:308-343",
      "use_cases": [
        "On session load from disk",
        "Before creating new session",
        "Before updating existing session"
      ]
    },
    "attachment_sanitization": {
      "description": "Validate and limit attachments",
      "code_template": "function sanitizeAttachments(rawAttachments) {\n  if (!Array.isArray(rawAttachments)) return [];\n  \n  return rawAttachments\n    .filter(att => att && typeof att.content === 'string')\n    .slice(0, MAX_ATTACHMENTS)\n    .map(att => ({\n      id: att.id || crypto.randomUUID(),\n      name: (att.name || 'Attachment').toString().slice(0, 120),\n      type: att.type === 'file' ? 'file' : 'text',\n      content: att.content.slice(0, ATTACHMENT_CHAR_LIMIT)\n    }));\n}",
      "location": "server.js:459-474",
      "limits": {
        "max_count": 10,
        "max_size_per_attachment": "200KB (200,000 chars)",
        "name_max_length": 120
      }
    },
    "persistence": {
      "description": "Save sessions to disk",
      "code_template": "function persistSessions() {\n  const data = JSON.stringify(sessionStore, null, 2);\n  fs.writeFileSync(SESSIONS_FILE, data, 'utf8');\n}",
      "location": "server.js:345-352",
      "file": "storage/sessions.json",
      "format": "Pretty-printed JSON (2-space indent)",
      "triggers": [
        "Session create",
        "Session update",
        "Session delete",
        "Active session change"
      ]
    },
    "default_session_protection": {
      "description": "Prevent deletion of default session",
      "code_template": "if (sessionId === 'default') {\n  return res.status(400).json({ error: 'Cannot delete the default session' });\n}",
      "location": "server.js:1563-1583",
      "reason": "Ensures at least one session always exists"
    },
    "preset_linking": {
      "description": "Link session to instruction preset",
      "code_template": "const preset = INSTRUCTION_PRESETS.find(p => p.id === selectedPresetId);\nif (preset && normalizeInstructionText(instructions) === normalizeInstructionText(preset.instructions)) {\n  payload.presetId = selectedPresetId;\n} else {\n  payload.presetId = null; // User customized the preset\n}",
      "location": "server.js:533-538",
      "normalization": "function normalizeInstructionText(value) {\n  return value ? value.replace(/\\r\\n/g, '\\n').trim() : '';\n}",
      "key_point": "presetId cleared if instructions don't match exactly"
    },
    "active_session_switching": {
      "description": "Change active session with cleanup",
      "code_template": "sessionStore.activeSessionId = sessionId;\npersistSessions();\nreturn res.json(sessionStore.sessions[sessionId]);",
      "location": "server.js:1487-1509",
      "triggers": [
        "User selects session in UI",
        "Deleting currently active session (switches to 'default')"
      ]
    }
  },
  "environment_variables": {
    "MAX_ATTACHMENTS": {
      "description": "Maximum attachments per session",
      "default": 10,
      "type": "number"
    },
    "ATTACHMENT_CHAR_LIMIT": {
      "description": "Max characters per attachment",
      "default": 200000,
      "type": "number",
      "note": "~200KB"
    }
  },
  "common_mistakes": [
    {
      "mistake": "Not normalizing session before saving",
      "impact": "Missing required fields, invalid data types",
      "fix": "Always call normalizeSession() before persist",
      "location": "server.js:308-343"
    },
    {
      "mistake": "Allowing unlimited attachments",
      "impact": "Memory exhaustion, slow performance",
      "fix": "Use sanitizeAttachments() to enforce MAX_ATTACHMENTS",
      "location": "server.js:459-474"
    },
    {
      "mistake": "Forgetting to update updatedAt timestamp",
      "impact": "Incorrect sorting, stale data indicators",
      "fix": "Set updatedAt: new Date().toISOString() on updates",
      "pattern": "Always update timestamp in PUT /api/sessions/:id"
    },
    {
      "mistake": "Not preserving history on session update",
      "impact": "Chat history lost",
      "fix": "session.history = existingSession.history || []",
      "location": "server.js:1528-1561"
    },
    {
      "mistake": "Deleting default session",
      "impact": "App breaks (no fallback session)",
      "fix": "Check if (sessionId === 'default') before delete",
      "location": "server.js:1563-1583"
    },
    {
      "mistake": "Comparing instructions without normalization",
      "impact": "presetId incorrectly cleared due to CRLF vs LF differences",
      "fix": "Use normalizeInstructionText() for comparison",
      "location": "server.js:476-482"
    }
  ],
  "frontend_integration": {
    "state_management": {
      "storage": "state.sessions array + localStorage('activeSession')",
      "sync_pattern": "Fetch from server on load, persist on changes",
      "location": "public/app.js:1917-2032"
    },
    "events": {
      "session_create": "POST /api/sessions → Update state → Persist localStorage",
      "session_switch": "POST /api/sessions/:id/select → Load history → Update UI",
      "session_delete": "DELETE /api/sessions/:id → Remove from state → Refresh list"
    }
  },
  "testing": {
    "verification_script": "scripts/verify.js::verifySessionPresetSync()",
    "test_cases": [
      "Create session without preset",
      "Create session with preset",
      "Update session preserves history",
      "Cannot delete default session",
      "Attachment sanitization enforces limits",
      "Preset link cleared on instruction edit"
    ],
    "manual_test_commands": [
      "curl http://localhost:3000/api/sessions",
      "curl -X POST http://localhost:3000/api/sessions -H 'Content-Type: application/json' -d '{\"name\":\"Test\"}'",
      "curl -X DELETE http://localhost:3000/api/sessions/default (should fail)"
    ]
  },
  "security_considerations": {
    "input_validation": "All user input sanitized via normalizeSession()",
    "path_traversal": "Not applicable (no filesystem paths from session data)",
    "injection": "JSON-only storage, no SQL/command injection risk",
    "size_limits": "Enforced at ATTACHMENT_CHAR_LIMIT and MAX_ATTACHMENTS"
  }
}
