{
  "name": "Instruction Preset Specialist",
  "domain": "prompt-engineering",
  "version": "1.0",
  "expertise": [
    "xml-structured-prompts",
    "workflow-metadata",
    "preset-management",
    "autonomous-agent-prompts",
    "chain-of-thought"
  ],
  "data_structures": {
    "InstructionPreset": {
      "schema": {
        "id": "string (unique identifier)",
        "label": "string (display name)",
        "description": "string (short summary)",
        "instructions": "string (full XML-structured prompt)",
        "version": "string (semver, e.g., '2.0')",
        "category": "enum ['general', 'coding', 'analysis']",
        "workflow": {
          "requiresDiscovery": "boolean",
          "autoComplete": "boolean",
          "strictXML": "boolean",
          "phases": "array of strings"
        },
        "updatedAt": "ISO8601 string"
      },
      "location": "server.js:103-251"
    }
  },
  "built_in_presets": {
    "default-assistant": {
      "id": "default-assistant",
      "label": "Default Assistant",
      "category": "general",
      "version": "2.0",
      "updated": "2025-01-14",
      "location": "server.js:103-155",
      "key_features": [
        "XML-tagged instruction structure",
        "Interaction rules (curiosity, detail-oriented)",
        "4-step workflow (understand → plan → execute → verify)",
        "Professional tone without superlatives",
        "Finish criteria: Complete tasks before responding"
      ],
      "xml_structure": {
        "role": "You are a meticulous, detail-oriented assistant...",
        "interaction_rules": "Ask targeted follow-up questions, provide thorough analysis",
        "workflow": "understand → plan → execute → verify",
        "output_style": "Clear, structured, professional",
        "finish_criteria": "Complete tasks fully before responding"
      }
    },
    "ai-coder-prompt": {
      "id": "ai-coder-prompt",
      "label": "AI Coder Prompt",
      "category": "coding",
      "version": "2.0",
      "updated": "2025-01-14",
      "location": "server.js:157-251",
      "key_features": [
        "Autonomous completion without asking for next steps",
        "Todo-driven workflow",
        "Chain-of-thought reasoning",
        "Test-driven development",
        "XML formatting enforcement",
        "Model preferences (Claude Sonnet 4.5, Opus 4.1)"
      ],
      "workflow_phases": [
        "discovery - Read files, grep/glob search",
        "todo_creation - Break down into actionable tasks",
        "execution - Write/edit code, run tests",
        "verification - Ensure correctness, handle errors",
        "documentation - Update relevant docs"
      ],
      "critical_rules": [
        "Complete all tasks without asking user for next steps",
        "Never end responses with 'Would you like me to...'",
        "Always use chain-of-thought before code changes",
        "Verify file paths before edits",
        "Run tests after implementation"
      ],
      "model_preferences": {
        "primary": "claude-sonnet-4.5 (default for most tasks)",
        "complex": "claude-opus-4.1 (intricate problems)",
        "long_context": "claude-sonnet-4 1M ctx (large codebases)"
      }
    }
  },
  "api_contracts": {
    "GET /api/settings": {
      "location": "server.js:1414-1443",
      "response": {
        "defaults": "object (DEFAULT_SETTINGS)",
        "current": "object (runtimeSettings)",
        "presets": "array (INSTRUCTION_PRESETS)"
      },
      "caching": "Presets cached in INSTRUCTION_PRESETS constant"
    }
  },
  "patterns": {
    "xml_prompt_structure": {
      "description": "Consistent XML tagging for LLM instructions",
      "template": "<role>Define assistant identity</role>\n<interaction_rules>\n  <rule>Specific behavior guideline</rule>\n</interaction_rules>\n<workflow>\n  <step name=\"phase1\">Description</step>\n  <step name=\"phase2\">Description</step>\n</workflow>\n<output_style>\n  <guideline>Formatting preference</guideline>\n</output_style>\n<finish_criteria>\nCompletion requirements\n</finish_criteria>",
      "benefits": [
        "Clear section boundaries for LLM parsing",
        "Easy to extend with new sections",
        "Self-documenting structure",
        "Works well with Claude's XML understanding"
      ],
      "location": "server.js:103-251"
    },
    "instruction_normalization": {
      "description": "Normalize instructions for comparison",
      "code_template": "function normalizeInstructionText(value) {\n  return value ? value.replace(/\\r\\n/g, '\\n').trim() : '';\n}",
      "location": "server.js:476-482",
      "use_case": "Detect if user modified preset instructions"
    },
    "preset_deduplication": {
      "description": "Only set presetId if instructions match exactly",
      "code_template": "const preset = INSTRUCTION_PRESETS.find(p => p.id === selectedPresetId);\nif (preset && normalizeInstructionText(instructions) === normalizeInstructionText(preset.instructions)) {\n  payload.presetId = selectedPresetId;\n} else {\n  payload.presetId = null; // Custom instructions\n}",
      "location": "server.js:533-538",
      "purpose": "Prevent false preset associations when user customizes prompt"
    },
    "workflow_metadata": {
      "description": "Structured workflow definition",
      "schema": {
        "requiresDiscovery": "boolean - needs codebase exploration first",
        "autoComplete": "boolean - finish tasks without user confirmation",
        "strictXML": "boolean - enforce XML-tagged responses",
        "phases": "array - ordered workflow steps"
      },
      "example": {
        "requiresDiscovery": true,
        "autoComplete": true,
        "strictXML": true,
        "phases": ["discovery", "planning", "implementation", "verification"]
      },
      "location": "server.js:157-251"
    },
    "autonomous_agent_pattern": {
      "description": "Prompt structure for self-completing agents",
      "key_directives": [
        "Complete all tasks before responding",
        "Never ask 'Would you like me to...'",
        "Use chain-of-thought reasoning",
        "Create todos, mark in_progress, complete",
        "Verify changes with tests/builds"
      ],
      "antipatterns": [
        "Ending with questions about next steps",
        "Partial implementation without verification",
        "Skipping todo list creation",
        "Not running tests after changes"
      ],
      "location": "server.js:157-251 (ai-coder-prompt)"
    }
  },
  "common_mistakes": [
    {
      "mistake": "Not normalizing instructions before comparison",
      "impact": "presetId incorrectly cleared due to line ending differences",
      "fix": "Use normalizeInstructionText() for all comparisons",
      "location": "server.js:476-482"
    },
    {
      "mistake": "Modifying INSTRUCTION_PRESETS at runtime",
      "impact": "Changes lost on server restart, inconsistent state",
      "fix": "Treat INSTRUCTION_PRESETS as immutable constant",
      "note": "User customizations go in session.instructions, not preset"
    },
    {
      "mistake": "Forgetting to update preset version on changes",
      "impact": "Users can't tell if preset was updated",
      "fix": "Increment version + update updatedAt when modifying presets"
    },
    {
      "mistake": "Overly verbose prompts (>2000 tokens)",
      "impact": "Reduces available context for actual conversation",
      "fix": "Keep presets concise, ~500-1000 tokens ideal",
      "measurement": "Use tokenizer to check (tiktoken for Claude)"
    },
    {
      "mistake": "Not testing preset with target models",
      "impact": "Prompt works on Opus but fails on Haiku",
      "fix": "Test on smallest intended model first",
      "recommended_test_model": "claude-haiku-3.5 (fast, strict parser)"
    }
  ],
  "prompt_engineering_best_practices": {
    "structure": [
      "Start with role definition",
      "Provide interaction rules",
      "Define workflow phases",
      "Specify output formatting",
      "Set completion criteria"
    ],
    "tone": [
      "Professional, avoid superlatives",
      "Direct, no unnecessary praise",
      "Objective, fact-focused"
    ],
    "workflow": [
      "Break complex tasks into phases",
      "Require verification steps",
      "Encourage chain-of-thought",
      "Enforce testing/validation"
    ],
    "xml_benefits": [
      "Claude models excel at XML parsing",
      "Clear semantic boundaries",
      "Easy to extend/modify",
      "Self-documenting structure"
    ]
  },
  "extending_presets": {
    "adding_new_preset": {
      "steps": [
        "Define preset object with id, label, description",
        "Write instructions with XML structure",
        "Add version and updatedAt",
        "Define workflow metadata",
        "Push to INSTRUCTION_PRESETS array",
        "Test with target models"
      ],
      "location": "server.js:103-251",
      "example": "{\n  id: 'data-analyst',\n  label: 'Data Analyst',\n  description: 'Specialized in data analysis and visualization',\n  instructions: '<role>...</role>',\n  version: '1.0',\n  category: 'analysis',\n  workflow: {...},\n  updatedAt: '2025-01-14T00:00:00.000Z'\n}"
    },
    "updating_existing_preset": {
      "steps": [
        "Modify instructions field",
        "Increment version (e.g., '2.0' → '2.1')",
        "Update updatedAt timestamp",
        "Test changes with verification script",
        "Document changes in commit message"
      ],
      "caution": "Existing sessions with presetId won't auto-update (by design)"
    }
  },
  "testing": {
    "verification_script": "scripts/verify.js::verifyPresetCaching()",
    "test_cases": [
      "Presets loaded on startup",
      "GET /api/settings returns presets array",
      "Preset deduplication works correctly",
      "Instruction normalization handles CRLF",
      "Session preset sync maintains link"
    ],
    "manual_testing": [
      "Create session with ai-coder-prompt",
      "Verify instructions match preset exactly",
      "Edit instructions slightly",
      "Verify presetId cleared",
      "Switch back to preset",
      "Verify presetId restored"
    ]
  },
  "model_compatibility": {
    "claude_sonnet_4.5": {
      "strengths": "Fast, excellent XML parsing, balanced performance",
      "recommended_for": "General coding, standard tasks"
    },
    "claude_opus_4.1": {
      "strengths": "Superior reasoning, complex problem-solving",
      "recommended_for": "Architecture design, intricate debugging"
    },
    "claude_sonnet_4_1M": {
      "strengths": "1M token context window",
      "recommended_for": "Large codebase analysis, full project refactoring"
    },
    "qwen_models": {
      "note": "Default Ollama models, may not follow XML strictly",
      "recommendation": "Test presets with qwen before deployment"
    }
  },
  "future_enhancements": {
    "dynamic_presets": "Allow users to create custom presets in UI",
    "preset_versioning": "Track preset history, allow rollback",
    "preset_sharing": "Export/import presets between instances",
    "ai_preset_suggestions": "Recommend preset based on user message"
  }
}
